{% extends 'todos/base.html' %}

{% block title %}
<title>Todo list</title>
{% endblock %}

{% block content %}
<div class="container">

  <!-- title row -->
  <div class="row">
    <div class="offset-md-2 col-lg-9">
      <div class="page-header">
        <h1>
          Todo List
        </h1>
        <!-- ここに日付を追加 -->
        <div class="date-header">
          {{ current_date|date:"Y-m-d" }}
        </div>
      </div>
    </div>
  </div>

  <!-- Add a todo row -->
  <div class="row">
    <div class="offset-md-2 col-lg-9">
      <form method="post" action="{% url 'todos:add' %}">
        {% csrf_token %}
        <div class="form-row">
          <div class="col-md-6">
            <input type="text" class="form-control" name="title" placeholder="タイトルを入力してください" required>
          </div>
          <div class="col-md-6">
            <button type="submit" name="submit" class="btn btn-outline-primary">
              追加
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
  <hr />

  <!-- 編集モード切り替えボタン -->
  <div class="row">
    <div class="offset-md-2 col-lg-9">
      <button id="toggle-edit-mode" class="btn btn-outline-secondary">タイトル位置移動</button>
    </div>
  </div>
  <hr />

  <!-- todo list row -->
  <div class="row">
    <div class="offset-md-2 col-lg-6">
      <div class="list-group sortable" id="sortable-list">
        {% for todo in todo_list %}
        <div class="list-group-item" data-todo-id="{{ todo.id }}">
          <div class="todo-details">
            <div class="todo-details-left">
              <span class="todo-title">{{ todo.title }}</span>
              <small class="text-muted">追加日: {{ todo.created_at|date:"Y-m-d" }}</small>
              <!-- {% if todo.notes %}
              <div class="todo-notes">{{ todo.notes }}</div>
              {% endif %} -->
            </div>
            <div class="todo-actions">
              <a href="{% url 'todos:edit' todo.id %}" title="Edit">
                <i class="far fa-edit"></i>
              </a>
              <a href="{% url 'todos:delete' todo.id %}" title="Delete">
                <i class="far fa-trash-alt"></i>
              </a>
              <span class="drag-handle" style="cursor: move; margin-left: 10px;">&#9776;</span>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

{% block extra_scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK" crossorigin="anonymous"></script>

<script>
  $(function() {
    var editMode = false;

    $("#toggle-edit-mode").click(function() {
      editMode = !editMode;
      $(this).text(editMode ? '完了' : 'タイトル位置移動');
      $("#sortable-list").sortable("option", "disabled", !editMode);
      console.log("Edit mode switched to: ", editMode);
    });

    $("#sortable-list").sortable({
      handle: ".drag-handle",  
      disabled: true,
      update: function(event, ui) {
        if (!editMode) return;
        var todo_ids = [];
        $("#sortable-list .list-group-item").each(function(index) {
          var todo_id = $(this).data("todo-id");
          todo_ids.push(todo_id);
        });
        $.ajax({
          url: "{% url 'todos:update_order' %}",
          type: "POST",
          data: {
            todo_ids: todo_ids,
            csrfmiddlewaretoken: '{{ csrf_token }}'
          },
          success: function(data) {
            console.log("Order updated successfully");
          },
          error: function(xhr, errmsg, err) {
            console.log("Error updating order");
          }
        });
      }
    });
    $("#sortable-list").disableSelection();
  });
  
</script>
{% endblock %}

{% endblock %}
